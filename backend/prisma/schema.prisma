generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model analytics {
  id           String   @id
  metric_name  String
  metric_value String
  date         DateTime @default(now())
  metadata     String?

  @@index([date])
  @@index([metric_name, date])
}

model completion_history {
  id              String   @id
  user_id         String
  task_name       String
  completed_date  DateTime @default(now())
  streak_day      Int
  created_at      DateTime @default(now())
  completion_time String?
  notes           String?
  room_id         String?
  pillar_type     String?
  task_type       String?
  rotation_id     String?
  users           users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([task_name])
  @@index([user_id, task_name])
  @@index([completed_date])
  @@index([user_id, completed_date])
}

model user_sessions {
  id            String   @id
  user_id       String
  refresh_token String   @unique
  device_info   String?
  ip_address    String?
  created_at    DateTime @default(now())
  last_accessed DateTime @default(now())
  expires_at    DateTime
  is_active     Boolean  @default(true)
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([is_active])
  @@index([expires_at])
  @@index([refresh_token])
  @@index([user_id])
}

model user_streaks {
  id             String    @id
  user_id        String
  task_name      String
  current_streak Int       @default(0)
  best_streak    Int       @default(0)
  last_completed DateTime?
  created_at     DateTime  @default(now())
  updated_at     DateTime
  users          users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, task_name])
  @@index([last_completed])
  @@index([task_name])
  @@index([user_id])
}

model users {
  id                   String                 @id
  email                String                 @unique
  password_hash        String
  created_at           DateTime               @default(now())
  updated_at           DateTime
  last_login           DateTime?
  email_verified       Boolean                @default(false)
  email_verified_at    DateTime?
  completion_history   completion_history[]
  user_sessions        user_sessions[]
  user_streaks         user_streaks[]
  user_rooms           user_rooms[]
  user_keystone_tasks  user_keystone_tasks[]
  task_rotation        task_rotation[]
  user_task_progress   user_task_progress?
  pending_room_configs pending_room_configs?

  @@index([last_login])
  @@index([created_at])
  @@index([email])
}

model user_rooms {
  id          String   @id
  user_id     String
  room_type   String
  custom_name String
  has_glass   Boolean  @default(true)
  sort_order  Int
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([user_id, sort_order])
}

model user_keystone_tasks {
  id          String   @id
  user_id     String
  task_type   String
  custom_name String?
  is_active   Boolean  @default(true)
  sort_order  Int
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, task_type])
  @@index([user_id])
}

model task_rotation {
  id               String   @id
  user_id          String
  task_type        String
  task_description String
  room_id          String?
  pillar_type      String?
  keystone_type    String?
  sequence_position Int
  rotation_version Int
  created_at       DateTime @default(now())
  users            users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, rotation_version, sequence_position])
  @@index([user_id, rotation_version, sequence_position])
}

model user_task_progress {
  id                         String   @id
  user_id                    String   @unique
  current_task_index         Int      @default(1)
  current_rotation_version   Int      @default(1)
  last_completed_task_id     String?
  rotation_generated_at      DateTime @default(now())
  has_pending_config_changes Boolean  @default(false)
  updated_at                 DateTime @updatedAt
  users                      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model pending_room_configs {
  id          String   @id
  user_id     String   @unique
  config_data String
  created_at  DateTime @default(now())
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}
